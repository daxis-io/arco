name: Nightly Chaos Tests

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      chaos_seed:
        description: 'Seed for deterministic chaos (leave empty for random)'
        required: false
        type: string
      chaos_duration_minutes:
        description: 'Duration of chaos test in minutes'
        required: false
        default: '30'
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Deterministic Simulation Tests
  # ==========================================================================
  simulation:
    name: Simulation Tests
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: flaky-network
            seed: 12345
          - name: contended-storage
            seed: 67890
          - name: chaos
            seed: 11111
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run simulation (${{ matrix.scenario.name }})
        env:
          ARCO_SIM_SEED: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.chaos_seed || matrix.scenario.seed }}
          ARCO_SIM_SCENARIO: ${{ matrix.scenario.name }}
        run: |
          cargo test --package arco-test-utils \
            --features simulation \
            --test simulation_scenarios \
            -- --ignored --nocapture

  # ==========================================================================
  # Long-Running Stress Tests
  # ==========================================================================
  stress:
    name: Stress Tests
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run stress tests
        env:
          ARCO_STRESS_DURATION_SECS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.chaos_duration_minutes && format('{0}', fromJSON(github.event.inputs.chaos_duration_minutes) * 60) || '1800' }}
        run: |
          cargo test --package arco-integration-tests \
            --features stress \
            -- --ignored --test-threads=1 --nocapture

  # ==========================================================================
  # Concurrent Writer Contention Tests
  # ==========================================================================
  contention:
    name: Contention Tests
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run concurrent writer tests
        run: |
          cargo test --package arco-catalog \
            --features contention-tests \
            -- --ignored concurrent_ --test-threads=1

  # ==========================================================================
  # Property-Based Tests (Extended)
  # ==========================================================================
  proptest:
    name: Property-Based Tests (Extended)
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run extended property tests
        env:
          # Run more proptest cases than default
          PROPTEST_CASES: 10000
        run: |
          cargo test --workspace \
            --features proptest-extended \
            -- proptest_ --nocapture

  # ==========================================================================
  # Fencing Token Stale Holder Tests
  # ==========================================================================
  fencing:
    name: Fencing Token Tests
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run fencing token tests
        run: |
          cargo test --package arco-catalog \
            --features fencing-tests \
            -- stale_holder --nocapture

  # ==========================================================================
  # Anti-Entropy Convergence Tests
  # ==========================================================================
  anti-entropy:
    name: Anti-Entropy Convergence
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Run anti-entropy tests
        run: |
          cargo test --package arco-compactor \
            --features convergence-tests \
            -- anti_entropy --ignored --nocapture

  # ==========================================================================
  # Notify on Failure
  # ==========================================================================
  notify-failure:
    name: Notify on Failure
    # TODO: Enable when chaos test targets land (Phase 5).
    if: false
    runs-on: ubuntu-latest
    needs: [simulation, stress, contention, proptest, fencing, anti-entropy]
    steps:
      - name: Create failure summary
        run: |
          echo "## Nightly Chaos Test Failure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more chaos tests failed. Please investigate." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      # Uncomment when Slack webhook is configured
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Nightly chaos tests failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
