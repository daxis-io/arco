name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  gates:
    name: Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.18.3
      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          # Pin to a stable version that supports buf.yaml v2 format
          version: '1.47.2'
      - run: cargo xtask doctor
      - run: cargo xtask adr-check
      - run: cargo xtask verify-integrity

  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --workspace --all-features

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --workspace --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --workspace --all-features --exclude arco-flow
      - run: cargo test -p arco-flow --features test-utils

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: python/arco/pyproject.toml
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
        working-directory: python/arco
      - name: Run Python CLI API tests
        run: python -m pytest tests/integration/test_cli_api.py -v
        working-directory: python/arco

  docs:
    name: Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.18.3
      - run: cargo deny check

  proto-check:
    name: Proto Compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          # Pin to a stable version that supports buf.yaml v2 format
          version: '1.47.2'

      - name: Lint protos
        run: buf lint proto/

      - name: Check breaking changes
        if: github.event_name == 'pull_request'
        run: |
          buf breaking proto/ \
            --against 'https://github.com/${{ github.repository }}.git#branch=main,subdir=proto'

  # ==========================================================================
  # Gate 5: IAM Smoke Tests (deployed environment)
  # ==========================================================================
  iam-smoke:
    name: IAM Smoke Tests
    runs-on: ubuntu-latest
    # Only run on main branch pushes, not PRs (requires deployed infrastructure)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: dev
    needs: [check, test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2

      - name: Authenticate to GCP (API SA)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_API }}

      - name: Run API IAM smoke tests
        env:
          ARCO_TEST_BUCKET: ${{ vars.ARCO_BUCKET_DEV }}
        run: |
          cargo test --package arco-integration-tests \
            --features iam-smoke \
            -- --ignored --test-threads=1

  # ==========================================================================
  # Compile-Negative Tests (Gate 5 trait separation)
  # ==========================================================================
  compile-negative:
    name: Compile-Negative Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85
      - uses: Swatinem/rust-cache@v2
      - name: Run UI/compile-fail tests
        run: cargo test -p arco-core --test ui
