# Prometheus Alert Rules for Arco Flow Orchestration
#
# Deploy these rules to your Prometheus server or Alertmanager.
# Adjust thresholds based on your SLOs and traffic patterns.

groups:
  - name: arco-flow-go-live-gates
    rules:
      - alert: ArcoFlowCallback5xxRateHigh
        expr: |
          (
            sum(rate(arco_orch_callbacks_total{result=~"5.."}[5m]))
            /
            clamp_min(sum(rate(arco_orch_callbacks_total[5m])), 1)
          ) > 0.01
          and
          sum(rate(arco_orch_callbacks_total[5m])) > 0.2
        for: 5m
        labels:
          severity: critical
          team: data-platform
        annotations:
          summary: Callback 5xx rate exceeds 1%
          description: |
            Callback 5xx ratio exceeded 1% over 5m with sufficient request volume.
            Check callback auth, token validation, and ledger write dependencies.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

      - alert: ArcoFlowStaleFenceRejects
        expr: increase(arco_flow_orch_compactor_stale_fence_rejects_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          team: data-platform
        annotations:
          summary: Stale fence rejects detected
          description: |
            Orchestration compactor reported stale fence rejects in the last 5 minutes.
            This indicates competing writers or lock epoch drift.
          runbook_url: https://docs.arco.dev/runbooks/storage-integrity-verification

  - name: arco-flow-slos
    rules:
      # Task Failure Rate SLO: < 5% failure rate
      - alert: ArcoFlowHighTaskFailureRate
        expr: |
          (
            sum(rate(arco_flow_tasks_total{to_state="failed"}[5m]))
            /
            sum(rate(arco_flow_tasks_total{to_state=~"succeeded|failed"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: High task failure rate detected
          description: |
            Task failure rate is {{ $value | humanizePercentage }} (threshold: 5%).
            Check worker logs and upstream data sources.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

      - alert: ArcoFlowCriticalTaskFailureRate
        expr: |
          (
            sum(rate(arco_flow_tasks_total{to_state="failed"}[5m]))
            /
            sum(rate(arco_flow_tasks_total{to_state=~"succeeded|failed"}[5m]))
          ) > 0.30
        for: 2m
        labels:
          severity: critical
          team: data-platform
        annotations:
          summary: Critical task failure rate - immediate attention required
          description: |
            Task failure rate is {{ $value | humanizePercentage }} (threshold: 30%).
            Consider pausing affected pipelines.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

  - name: arco-flow-scheduler
    rules:
      # Scheduler Health
      - alert: ArcoFlowSchedulerStalled
        expr: |
          rate(arco_flow_scheduler_tick_duration_seconds_count[5m]) < 0.1
        for: 5m
        labels:
          severity: critical
          team: data-platform
        annotations:
          summary: Scheduler is not making progress
          description: |
            Scheduler tick rate is {{ $value }}/s (expected: >0.1/s).
            Tasks are not being scheduled. Check scheduler pod health.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      - alert: ArcoFlowSchedulerSlowTicks
        expr: |
          histogram_quantile(0.99, sum(rate(arco_flow_scheduler_tick_duration_seconds_bucket[5m])) by (le)) > 10
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Scheduler ticks are slow
          description: |
            P99 scheduler tick duration is {{ $value | humanizeDuration }}.
            This may indicate database contention or high task volume.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

  - name: arco-flow-tasks
    rules:
      # Task Latency SLO: P99 < 5 minutes
      - alert: ArcoFlowTaskLatencySLO
        expr: |
          histogram_quantile(0.99, sum(rate(arco_flow_task_duration_seconds_bucket{state="succeeded"}[15m])) by (le)) > 300
        for: 15m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Task latency SLO at risk
          description: |
            P99 task duration is {{ $value | humanizeDuration }} (SLO: 5 minutes).
            Check for resource constraints or slow dependencies.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

      # Stuck Tasks
      - alert: ArcoFlowTasksStuckDispatched
        expr: |
          sum(increase(arco_flow_tasks_total{to_state="dispatched"}[5m])) > 0
          and
          sum(increase(arco_flow_tasks_total{to_state="running"}[5m])) == 0
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Tasks stuck in dispatched state
          description: |
            Tasks are being dispatched but not transitioning to running.
            Check worker connectivity and Cloud Tasks queue.
          runbook_url: https://docs.arco.dev/runbooks/task-stuck-dispatched

      # Retry Storm
      - alert: ArcoFlowRetryStorm
        expr: |
          sum(rate(arco_flow_retries_total[5m])) > 50
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: High retry rate detected
          description: |
            Retry rate is {{ $value }}/s. This indicates systemic failures.
            Investigate root cause before retries exhaust.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

  - name: arco-flow-capacity
    rules:
      # Queue Depth
      - alert: ArcoFlowDispatchQueueBacklog
        expr: |
          sum(arco_flow_dispatch_queue_depth) > 1000
        for: 10m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Dispatch queue backlog building
          description: |
            Queue depth is {{ $value }} tasks.
            Workers may be falling behind or Cloud Tasks is throttling.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      # Active Runs Limit (uses max to avoid double-counting during leader failover)
      - alert: ArcoFlowHighActiveRuns
        expr: |
          max(arco_flow_active_runs) > 100
        for: 10m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: High number of active runs
          description: |
            System has {{ $value }} active runs.
            This may indicate stuck runs or excessive parallelism.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

  - name: arco-flow-reliability
    rules:
      # Data Freshness SLO (if tracking via custom metric)
      - alert: ArcoFlowDataFreshnessBreached
        expr: |
          arco_flow_asset_age_seconds > 3600
        for: 15m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Data freshness SLO breached
          description: |
            Asset {{ $labels.asset }} is {{ $value | humanizeDuration }} old (SLO: 1 hour).
            Check upstream pipeline health.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

      # No Successful Tasks
      - alert: ArcoFlowNoSuccessfulTasks
        expr: |
          sum(rate(arco_flow_tasks_total{to_state="succeeded"}[15m])) == 0
          and
          sum(arco_flow_active_runs) > 0
        for: 15m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: No tasks succeeding despite active runs
          description: |
            Active runs exist but no tasks are completing successfully.
            Investigate for systemic failures.
          runbook_url: https://docs.arco.dev/runbooks/high-task-failure-rate

  # ==========================================================================
  # Gate 5: Storage Integrity Alerts
  # ==========================================================================
  - name: arco-gate5-integrity
    rules:
      # CRITICAL: API should never write to state/ prefix
      - alert: ArcoApiWritingState
        expr: |
          increase(arco_storage_operations_total{service="api", operation="put_state"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
          team: data-platform
          gate5: true
        annotations:
          summary: GATE 5 VIOLATION - API writing to state/ prefix
          description: |
            API service is writing to state/ prefix which violates the "compactor is sole writer" invariant.
            This is a critical security issue - investigate immediately.
          runbook_url: https://docs.arco.dev/runbooks/gate5-violations

      # CRITICAL: Stale fencing token attempts
      - alert: ArcoStaleFencingToken
        expr: |
          increase(arco_publish_permit_consumed_total{result="stale_token"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
          team: data-platform
          gate5: true
        annotations:
          summary: GATE 5 VIOLATION - Stale fencing token publish attempt
          description: |
            A process attempted to publish with a stale fencing token.
            This could indicate a split-brain scenario or lock contention issue.
            Token: {{ $labels.fencing_token }}
          runbook_url: https://docs.arco.dev/runbooks/gate5-violations

      # CRITICAL: Manifest succession failure
      - alert: ArcoManifestSuccessionFailure
        expr: |
          increase(arco_manifest_succession_failures_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          team: data-platform
          gate5: true
        annotations:
          summary: GATE 5 VIOLATION - Manifest succession validation failed
          description: |
            Manifest update failed validation. Reason: {{ $labels.reason }}.
            This could indicate rollback attempt, concurrent modification, or data corruption.
          runbook_url: https://docs.arco.dev/runbooks/gate5-violations

      # WARNING: Anti-entropy finding gaps
      - alert: ArcoAntiEntropyGaps
        expr: |
          increase(arco_anti_entropy_gaps_found_total[1h]) > 10
        for: 5m
        labels:
          severity: warning
          team: data-platform
          gate5: true
        annotations:
          summary: Anti-entropy finding missed events
          description: |
            Anti-entropy discovered {{ $value }} missed events in the past hour.
            This indicates notification delivery issues.
          runbook_url: https://docs.arco.dev/runbooks/storage-integrity-verification

  # ==========================================================================
  # Gate 5: Backpressure Alerts
  # ==========================================================================
  - name: arco-gate5-backpressure
    rules:
      # WARNING: Soft backpressure threshold
      - alert: ArcoBackpressureSoftThreshold
        expr: |
          arco_backpressure_pending_lag > 5000
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Backpressure soft threshold exceeded
          description: |
            Domain {{ $labels.domain }} has pending lag of {{ $value }}.
            Compactor may be falling behind. Consider scaling compactor.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      # CRITICAL: Hard backpressure threshold
      - alert: ArcoBackpressureHardThreshold
        expr: |
          arco_backpressure_pending_lag > 10000
        for: 2m
        labels:
          severity: critical
          team: data-platform
        annotations:
          summary: Backpressure hard threshold - writes may be rejected
          description: |
            Domain {{ $labels.domain }} has critical pending lag of {{ $value }}.
            Writes are being rejected with retry_after headers.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      # WARNING: Backpressure rejections occurring
      - alert: ArcoBackpressureRejections
        expr: |
          increase(arco_backpressure_rejections_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Requests being rejected due to backpressure
          description: |
            {{ $value }} requests rejected in the past 5 minutes due to backpressure.
            Clients should be retrying with exponential backoff.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

  # ==========================================================================
  # Gate 5: Lock and CAS Alerts
  # ==========================================================================
  - name: arco-gate5-locks
    rules:
      # WARNING: High CAS contention
      - alert: ArcoHighCASContention
        expr: |
          (
            sum(rate(arco_cas_attempts_total{result="precondition_failed"}[5m]))
            /
            sum(rate(arco_cas_attempts_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: High CAS contention rate
          description: |
            CAS failure rate is {{ $value | humanizePercentage }}.
            This indicates high write contention on manifests.
          runbook_url: https://docs.arco.dev/runbooks/storage-integrity-verification

      # WARNING: Lock held too long
      - alert: ArcoLongHeldLock
        expr: |
          histogram_quantile(0.99, sum(rate(arco_lock_held_seconds_bucket[5m])) by (le, resource)) > 60
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Lock held for extended period
          description: |
            Lock {{ $labels.resource }} P99 hold time is {{ $value | humanizeDuration }}.
            This may indicate slow operations or potential deadlock.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      # WARNING: High lock contention
      - alert: ArcoHighLockContention
        expr: |
          (
            sum(rate(arco_lock_acquisitions_total{result="contention"}[5m]))
            /
            sum(rate(arco_lock_acquisitions_total[5m]))
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: High lock contention
          description: |
            Lock contention rate is {{ $value | humanizePercentage }}.
            Multiple processes competing for the same locks.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

  # ==========================================================================
  # Gate 5: Compaction Alerts
  # ==========================================================================
  - name: arco-gate5-compaction
    rules:
      # WARNING: Sync compaction timeout
      - alert: ArcoSyncCompactionTimeout
        expr: |
          histogram_quantile(0.99, sum(rate(arco_compaction_latency_seconds_bucket{trigger="sync_rpc"}[5m])) by (le)) > 30
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Sync compaction latency high
          description: |
            P99 sync compaction latency is {{ $value | humanizeDuration }}.
            Tier-1 DDL operations will be slow.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

      # WARNING: Compactor not running
      - alert: ArcoCompactorStalled
        expr: |
          time() - max(arco_compactor_last_run_timestamp) by (domain) > 600
        for: 5m
        labels:
          severity: warning
          team: data-platform
        annotations:
          summary: Compactor not running for domain
          description: |
            Domain {{ $labels.domain }} has not had a compaction run in {{ $value | humanizeDuration }}.
            Check compactor health.
          runbook_url: https://docs.arco.dev/runbooks/scheduler-not-progressing

# Recording rules for efficiency
  - name: arco-flow-recording
    rules:
      - record: arco_flow:task_failure_rate:5m
        expr: |
          sum(rate(arco_flow_tasks_total{to_state="failed"}[5m]))
          /
          sum(rate(arco_flow_tasks_total{to_state=~"succeeded|failed"}[5m]))

      - record: arco_flow:task_success_rate:5m
        expr: |
          sum(rate(arco_flow_tasks_total{to_state="succeeded"}[5m]))
          /
          sum(rate(arco_flow_tasks_total{to_state=~"succeeded|failed"}[5m]))

      - record: arco_flow:task_duration_p99:5m
        expr: |
          histogram_quantile(0.99, sum(rate(arco_flow_task_duration_seconds_bucket[5m])) by (le))

      - record: arco_flow:scheduler_tick_p99:5m
        expr: |
          histogram_quantile(0.99, sum(rate(arco_flow_scheduler_tick_duration_seconds_bucket[5m])) by (le))
